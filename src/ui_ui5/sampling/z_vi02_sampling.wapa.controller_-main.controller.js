sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/Device","sap/ui/core/Core","sap/ui/core/Fragment","sap/base/Log","sap/ui/model/json/JSONModel","./BaseController","sap/ui/core/library","sap/ui/core/message/Message","sap/m/MessageToast","sap/m/MessageB+
ox","sap/m/Button","sap/m/Dialog","sap/m/ButtonType","sap/m/DialogType","sap/m/Label","sap/m/ComboBox","sap/m/Text","sap/m/Input","sap/ui/core/BusyIndicator","../model/formatter","../libs/constants"],function(e,t,o,s,n,i,a,l,c,r,u,d,h,g,b,f,m,I,y,p,T,S){+
"use strict";var w=l.MessageType;var E;var M=n;var v=l.ValueState;return a.extend("z_vi02_sampling.controller.Main",{currentSelectedTableItemFromFirstSection:undefined,formatter:T,testing:false,selectedLgnum:"",onInit:function(){this.getView().addStyleCl+
ass(t.support.touch?"sapUiSizeCozy":"sapUiSizeCompact");this.startProcess()},startProcess:function(){if(this.testing){if(!this.testDialog){const e=this;this.testDialog=s.load({id:e.getView().getId(),name:"z_vi02_sampling.view.RequestsTest",controller:e})+
.then(function(e){return e})}this.testDialog.then(function(e){e.open()})}else{this.setScreenState(1);if(!this.getView()?.getModel("loginData")){p.show();this.requestData("VH_WarehouseNumberSet",[],this).then(e=>{let t=new i(e);this.getView().setModel(t,"+
lgnumsModel");this.getBaseLgnum()}).catch(e=>{p.hide();this.handleError(e);console.log(e)})}}},getBaseLgnum:function(){p.show();const e=S.service.url;var t=new sap.ui.model.odata.ODataModel(e,true);t.callFunction("/GetUserDefaultWarehouse",{method:"GET",+
urlParameters:{},success:function(e){if(e.Lgnum){this.selectedLgnum=e.Lgnum;this.getWCsFromLgnum(e.Lgnum)}else{this.openLoginDialog();p.hide()}}.bind(this),error:function(e){p.hide();this.handleError(e);console.log(e)}.bind(this)})},getWCsFromLgnum:funct+
ion(e){p.show();const t=this;const o=[{field:"Lgnum",sign:"EQ",value:e}];this.requestData("VH_WorkstationSet",o,this).then(e=>{let t=new i(e);this.getView().setModel(t,"wcsModel");this.openLoginDialog();p.hide()}).catch(e=>{t.handleError(e);p.hide();cons+
ole.log(e)})},openLoginDialog:function(){const e=this.getView().getModel("lgnumsModel").getData().results;const t=this.getView().getModel("wcsModel")?.getData().results;const o=this.selectedLgnum;const n=new i({lgnums:e,wcs:t,selectedLgnum:o});if(!this.o+
LoginDialog){const e=this;this.oLoginDialog=s.load({id:e.getView().getId(),name:"z_vi02_sampling.view.LoginPopup",controller:e}).then(function(t){e.getView().addDependent(t);t.setModel(n,"loginModel");return t})}else{this.byId("loginDialog").setModel(n,"+
loginModel")}this.oLoginDialog.then(function(e){e.open()})},handleLgnumChange:function(e){const t=e.getSource(),o=t.getSelectedKey(),s=t.getValue();if(!o&&s){t.setValueState(v.Error);t.setValueStateText(this.getTranslatedText("ComboBox.Lgnum.Error"))}els+
e{t.setValueState(v.None);const e=this.byId("workcenterComboBox").getValue();this.byId("workcenterComboBox").setEnabled(o.length>0);this.byId("btnLogin").setEnabled(e.length>0&&o.length>0);this.selectedLgnum=o;this.getWCsFromLgnum(o)}},handleWCChange:fun+
ction(e){const t=e.getSource(),o=t.getSelectedKey(),s=t.getValue();if(!o&&s){t.setValueState(v.Error);t.setValueStateText(this.getTranslatedText("ComboBox.WC.Error"))}else{t.setValueState(v.None);const e=this.byId("lgnumComboBox").getValue();this.byId("b+
tnLogin").setEnabled(o.length>0&&e.length>0)}},onLoginPressed:function(e){const t=this.byId("lgnumComboBox").getSelectedKey();const o=this.byId("workcenterComboBox").getSelectedKey();this.wcLoginRequest(t,o)},onCloseLoginDialog:function(){if(this.oLoginD+
ialog){this.byId("loginDialog").close()}},loginAfterClose:function(){this.byId("scanInput").focus()},wcLoginRequest:function(e,t){const o=this;p.show();const s=S.service.login;var n=new sap.ui.model.odata.ODataModel(s,true);n.read(`/LogonCollection(WORKS+
TATION='${t}',WS_MODE='SMPL')`,{success:o=>{const s=new i(o.results);this.getView().setModel(s,"loginResponse");let n=new i;n.Workcenter=t;n.Lgnum=e;n.User="sbabalev";this.getView().setModel(new i(n),"loginData");p.hide();this.onCloseLoginDialog()},error+
:e=>{o.handleError(e);console.log(e);p.hide()}})},onScanHuSubmit:function(e){p.show();const t=this.getView().getModel("loginData").getData();const o=t.Lgnum;const s=t.Workcenter;const n=e.getParameter("value");let a={};const l=S.service.url;var c=new sap+
.ui.model.odata.ODataModel(l,true);c.read(`/HUHeaderSet(Lgnum='${o}',Huident='${n}',Workstation='${s}')?$expand=NavToHUItem,NavToHUItemQuantity`,{success:e=>{if(e){if(e.NavToHUItem.results.length>1){const e=this.getTranslatedText("HuRead.MultProd.Text");+
const t=this.getTranslatedText("HuRead.MultProd.Title");u.show(e,{icon:u.Icon.ERROR,title:t,actions:[u.Action.OK]});this.byId("scanInput").focus();return}else{a={results:[e]};a.results[0].NavToHUItem=e.NavToHUItem.results[0];a.results[0].NavToHUItemQuant+
ity=e.NavToHUItemQuantity.results[0];this.getView().setModel(new i(a),"scannedHU");this.byId("huTable").setSelectedIndex(0)}}p.hide()},error:e=>{this.handleError(e);console.log(e);p.hide()}})},onHuSelect:function(e,t){const o=this.byId("huTable");let s=-+
1;if(t!==undefined){s=t}else{s=o.getSelectedIndex()}if(s!==-1){this.currentSelectedTableItemFromFirstSection=s;const e=this.getView().getModel("scannedHU").getData().results;const t=e[s];const o=new i(t);this.getView().setModel(o,"selectedRow");this.getV+
iew().setModel(o,"lastSelectedRow");this.getUoMsForProduct(t.NavToHUItem.Matnr)}},getUoMsForProduct:function(e){p.show();const t=[{field:"Product",sign:"EQ",value:e}];this.requestData("ProductUnitOfMeasureSet",t,this).then(e=>{this.getView().setModel(new+
 i(e.results),"uomsForProduct");this.getView().byId("inputUoMToRemove").setModel(new i(e));this.setScreenState(2);this.refreshModels();p.hide()}).catch(e=>{this.handleError(e);console.log(e);p.hide()})},onPbRemainingPress:function(){this.clearData();this+
.setScreenState(1)},onNoPutbackLeftPress:function(){this.onNoPtbackLeftRequest()},onNoPtbackLeftRequest:function(){const e=this.getView().getModel("selectedRow").getData();const t=e.Entitled;const o=e.Huident;const s=e.Lgnum;const n=e.NavToHUItem.Matnr;c+
onst i=this;const a=new sap.ui.model.odata.v2.ODataModel(S.service.url);const l={Entitled:t,Lgnum:s,Matnr:n,Huident:o};a.create("/HUWarehouseTaskSet",l,{success:function(e,t){i.clearData();i.setScreenState(1)},error:function(e){console.log(e)}})},clearDa+
ta:function(){this.getView().setModel(new i,"selectedRow");this.getView().setModel(new i,"lastSelectedRow");this.getView().setModel(new i,"scannedHU");this.byId("scanInput").setValue(undefined);this.byId("pmatTxt").setText(undefined);this.getView().byId(+
"inputUoMToRemove").setSelectedKey("");this.refreshModels();this.byId("scanInput").focus()},setScreenState:function(e){switch(e){case 1:this.byId("btn_putback").setEnabled(false);this.byId("btn_no_putback").setEnabled(false);this.byId("btn_confirm").setE+
nabled(false);this.byId("btn_confirm_zero").setEnabled(false);this.byId("inputQtyToRemove").setEnabled(false);this.byId("inputQtyToRemove").setValue(undefined);this.byId("inputUoMToRemove").setEnabled(false);this.byId("inputQtyToRemove").setValue(undefin+
ed);break;case 2:this.byId("btn_putback").setEnabled(false);this.byId("btn_no_putback").setEnabled(false);this.byId("btn_confirm").setEnabled(false);this.byId("btn_confirm_zero").setEnabled(true);this.byId("inputQtyToRemove").setEnabled(true);this.byId("+
inputQtyToRemove").setValue(undefined);this.byId("inputUoMToRemove").setEnabled(true);break;case 2.5:this.byId("btn_putback").setEnabled(false);this.byId("btn_no_putback").setEnabled(false);this.byId("btn_confirm").setEnabled(true);this.byId("btn_confirm+
_zero").setEnabled(true);this.byId("inputQtyToRemove").setEnabled(true);this.byId("inputUoMToRemove").setEnabled(true);break;case 3:this.byId("btn_putback").setEnabled(true);this.byId("btn_no_putback").setEnabled(false);this.byId("btn_confirm").setEnable+
d(false);this.byId("btn_confirm_zero").setEnabled(false);this.byId("inputQtyToRemove").setEnabled(false);this.byId("inputUoMToRemove").setEnabled(false);break;case 3.5:this.byId("btn_putback").setEnabled(false);this.byId("btn_no_putback").setEnabled(true+
);this.byId("btn_confirm").setEnabled(false);this.byId("btn_confirm_zero").setEnabled(false);this.byId("inputQtyToRemove").setEnabled(false);this.byId("inputUoMToRemove").setEnabled(false);break;default:this.byId("btn_putback").setEnabled(false);this.byI+
d("btn_no_putback").setEnabled(false);this.byId("btn_confirm").setEnabled(false);this.byId("btn_confirm_zero").setEnabled(false);this.byId("inputQtyToRemove").setEnabled(false);this.byId("inputQtyToRemove").setValue(undefined);this.byId("inputUoMToRemove+
").setEnabled(false);break}},handleUoMToRemoveChange:function(e){var t=e.getSource(),o=t.getSelectedKey(),s=t.getValue();if(!o&&s){t.setValueState(v.Error);t.setValueStateText(this.getTranslatedText("ComboBox.UoM.Error"))}else{t.setValueState(v.None)}},h+
andleQtyToRemoveChange:function(e){const t=e.getParameter("value");if(t){this.setScreenState(2.5)}else{this.setScreenState(2)}},onConfirmPressed:function(e,t){const o=this.byId("inputQtyToRemove").getValue();const s=this.byId("inputUoMToRemove").getSelec+
tedKey();if(+o>0||t===0){const{qtyTaken:e,qtyInHu:t}=this.makeUoMCalculations(o,s);if(e>t){const e=this.getTranslatedText("Confirm.QtyMore.Text");const t=this.getTranslatedText("Confirm.QtyMore.Title");u.show(e,{icon:u.Icon.ERROR,title:t,actions:[u.Actio+
n.OK]})}else if(e<t){this.setScreenState(3);this.postQtyRequest(o,s)}else{this.setScreenState(3.5);this.postQtyRequest(o,s)}}else{const e=this.getTranslatedText("Confirm.QtyZero.Text");const t=this.getTranslatedText("Confirm.QtyZero.Title");u.show(e,{ico+
n:u.Icon.ERROR,title:t,actions:[u.Action.OK]})}},onConfirmZeroQty:function(e){const t=this.byId("inputQtyToRemove").getValue();const o=this.getTranslatedText("ConfirmZero.NotEmpty.Text");const s=this.getTranslatedText("ConfirmZero.NotEmpty.Title");if(t){+
u.show(o,{icon:u.Icon.ERROR,title:s,actions:[u.Action.OK]})}else{this.openZeroQtyDialog()}},openZeroQtyDialog:function(){if(!this.oZeroQtyDialog){const e=this.getTranslatedText("ConfirmZeroPopup.Yes");const t=this.getTranslatedText("ConfirmZeroPopup.No")+
;const o=this.getTranslatedText("ConfirmZeroPopup.Text");const s=this.getTranslatedText("ConfirmZeroPopup.Title");this.oZeroQtyDialog=new h({type:b.Message,title:s,content:new I({text:o}),beginButton:new d({type:g.Emphasized,text:e,press:function(){this.+
setScreenState(3);this.oZeroQtyDialog.close()}.bind(this)}),endButton:new d({text:t,press:function(){this.oZeroQtyDialog.close()}.bind(this)})})}this.oZeroQtyDialog.open()},makeUoMCalculations:function(e,t){const o=this.getView().getModel("selectedRow").+
getData();const s=this.getView().getModel("uomsForProduct").getData().find(({AlternativeUnit:e})=>e===t);const n=this.getView().getModel("uomsForProduct").getData().find(({AlternativeUnit:e})=>e===o.NavToHUItem.Meins);const i=e*s.QuantityNumerator/s.Quan+
tityDenominator;const a=o.NavToHUItem.Quan*n.QuantityNumerator/n.QuantityDenominator;return{qtyTaken:i,qtyInHu:a}},postQtyRequest:function(e,t){p.show();const o=this;const s=this.getView().getModel("loginData")?.getData();const n=new sap.ui.model.odata.v+
2.ODataModel(S.service.url);const i={Huident:this.getView().getModel("selectedRow").getData().Huident,Lgnum:s.Lgnum,Quan:e,Unit:t,Workstation:s.Workcenter};n.create("/PostQuantitySet",i,{success:function(e,t){p.hide()},error:function(e){console.log(e);o.+
handleError(e);p.hide()}})},setCurrentLoggedInUser:function e(){var t=new XMLHttpRequest;t.onreadystatechange=function(){if(t.readyState==4&&t.status==200){var e=JSON.parse(t.responseText);var o=" "+e.id;this.byId("user").setText(this.byId("user").getTex+
t().concat(o))}}.bind(this);t.open("GET","/sap/bc/ui2/start_up",false);t.send(null)},setFocusOnScanInput:function e(t){var o=this.getView().byId(t);setTimeout(function(){o.focus()},0)},selectFirstTableRow:function e(t){let o=this.byId("huTable");const s=+
o.getRows()[0];if(t!==undefined){if(t<o.getBinding().getModel().getData().results.length){this.onHuSelect(undefined,t);setTimeout(function(){return o.setSelectedIndex(t)},0)}else if(s&&s.getCells()[0].getText()){this.onHuSelect(undefined,0);setTimeout(fu+
nction(){return s._setSelected(true)},0)}}else if(s&&s.getCells()[0].getText()){this.onHuSelect(undefined,0);setTimeout(function(){return s._setSelected(true)},0)}},refreshModels:function e(){var t=this.getView().oModels;for(const e in t){t[e].refresh()}+
},onExitPressed:function(){p.show();const e=this.getView().getModel("loginData")?.getData();const t=e.Lgnum;const o=e.Workcenter;const s=S.service.login;let n={LGNUM:t,WORKSTATION:o,WS_MODE:""};this.createData("LogoffCollection",n,this,s).then(e=>{consol+
e.log(e);u.show("Logged Off",{icon:u.Icon.SUCCESS,title:"Success",actions:[u.Action.OK]});this.startProcess();p.hide()}).catch(e=>{this.handleError(e);console.log(e);p.hide()})},onHUHeaderPressed:function(){const e=this.byId("lgnumInput").getValue();cons+
t t=this.byId("workcenterInput").getValue();const o=this.byId("HUNum").getValue();const s=S.service.url;const n=[{field:"Lgnum",sign:"EQ",value:e},{field:"Workstation",sign:"EQ",value:t},{field:"Huident",sign:"EQ",value:o}];var i=new sap.ui.model.odata.O+
DataModel(s,true);i.read(`/HUHeaderSet(Lgnum='${e}',Huident='${o}',Workstation='${t}')?$expand=NavToHUItem,NavToHUItemQuantity`,{success:e=>{console.log(e);const t=this.getTranslatedText("Success");u.show(e,{icon:u.Icon.SUCCESS,title:t,actions:[u.Action.+
OK]})},error:e=>{this.handleError(e);console.log(e)}})},onGetLgnumPressed:function(){const e=S.service.url;var t=new sap.ui.model.odata.ODataModel(e,true);t.callFunction("/GetUserDefaultWarehouse",{method:"GET",urlParameters:{},success:function(e){consol+
e.log(e);u.show(e,{icon:u.Icon.SUCCESS,title:"Success",actions:[u.Action.OK]})}.bind(this),error:function(e){this.handleError(e);console.log(e)}.bind(this)})},onTestLoginPressed:function(){const e=this.byId("lgnumInput").getValue();const t=this.byId("wor+
kcenterInput").getValue();const o=S.service.login;var s=new sap.ui.model.odata.ODataModel(o,true);s.read(`/LogonCollection(WORKSTATION='${t}',WS_MODE='SMPL')`,{success:e=>{console.log(e);u.show(e,{icon:u.Icon.SUCCESS,title:"Success",actions:[u.Action.OK]+
})},error:e=>{this.handleError(e);console.log(e)}})},onTestLogoffPressed:function(){const e=this.byId("lgnumInput").getValue();const t=this.byId("workcenterInput").getValue();const o=S.service.login;let s={LGNUM:e,WORKSTATION:t,WS_MODE:""};this.createDat+
a("LogoffCollection",s,this,o).then(e=>{console.log(e);u.show(e,{icon:u.Icon.SUCCESS,title:"Success",actions:[u.Action.OK]})}).catch(e=>{this.handleError(e);console.log(e)})},onGetWCsPressed:function(){const e=this.byId("lgnumInput").getValue();const t=[+
{field:"Lgnum",sign:"EQ",value:e}];this.requestData("VH_WorkstationSet",t,this).then(e=>{console.log(e);u.show(e,{icon:u.Icon.SUCCESS,title:"Success",actions:[u.Action.OK]})}).catch(e=>{this.handleError(e);console.log(e)})},onGetLgnumsPressed:function(){+
const e=[];this.requestData("VH_WarehouseNumberSet",e,this).then(e=>{console.log(e);u.show(e,{icon:u.Icon.SUCCESS,title:"Success",actions:[u.Action.OK]})}).catch(e=>{this.handleError(e);console.log(e)})},onGetUoMsPressed:function(){const e=this.byId("lgn+
umInput").getValue();const t=this.byId("msehlInput").getValue();const o=this.byId("msehiInput").getValue();const s=this.byId("workcenterInput").getValue();const n=this.byId("HUNum").getValue();const i=[{field:"Product",sign:"EQ",value:t}];this.requestDat+
a("ProductUnitOfMeasureSet",i,this).then(e=>{console.log(e);u.show(e,{icon:u.Icon.SUCCESS,title:"Success",actions:[u.Action.OK]})}).catch(e=>{this.handleError(e);console.log(e)})},onPostRequest:function(){const e=this.byId("lgnumInput").getValue();const +
t=this.byId("msehlInput").getValue();const o=this.byId("msehiInput").getValue();const s=this.byId("workcenterInput").getValue();const n=this.byId("HUNum").getValue();const i=this.byId("qtyInput").getValue();const a=new sap.ui.model.odata.v2.ODataModel(S.+
service.url);const l={Huident:n,Lgnum:e,Quan:i,Unit:o,Workstation:s};a.create("/PostQuantitySet",l,{success:function(e,t){console.log(e);u.show(e,{icon:u.Icon.SUCCESS,title:"Success",actions:[u.Action.OK]})},error:function(e){console.log(e)}})},onCloseTe+
sting:function(e){if(this.testDialog){this.byId("testDialog").close()}},onOpenTesLoginDialog:function(){const e=new i({User:"sbabalev",Workcenter:"",Lgnum:""});if(!this.oLoginDialog){const t=this;this.oLoginDialog=s.load({id:t.getView().getId(),name:"z_v+
i02_sampling.view.LoginPopup",controller:t}).then(function(o){t.getView().addDependent(o);o.setModel(e,"loginModel");return o})}else{this.byId("loginDialog").setModel(e,"loginModel")}this.oLoginDialog.then(function(e){e.open()})}})});                     